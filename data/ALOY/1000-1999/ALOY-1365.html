---
title: "[ALOY-1365] Improve how Alloy works with i18n and platform folders"
---
<table>
<tr><th>Type</th><td>Improvement</td></tr>
<tr><th>Priority</th><td>Critical</td></tr>
<tr><th>Status</th><td>Closed</td></tr>
<tr><th>Resolution</th><td>Fixed</td></tr>
<tr><th>Resolution Date</th><td>2016-03-16T21:15:28.000+0000</td></tr>
<tr><th>Affected Version/s</th><td>n/a</td></tr>
<tr><th>Fix Version/s</th><td>Release 5.2.1, alloy 1.8.0</td></tr>
<tr><th>Components</th><td>I18N</td></tr>
<tr><th>Labels</th><td>n/a</td></tr>
<tr><th>Reporter</th><td>Fokke Zandbergen</td></tr>
<tr><th>Assignee</th><td>Chris Barber</td></tr>
<tr><th>Created</th><td>2016-03-09T09:18:00.000+0000</td></tr>
<tr><th>Updated</th><td>2017-03-15T21:43:02.000+0000</td></tr>
</table>

<h3>Description</h3>

The recent regression reported under TIMOB-20537 and the open request to theme <code>Defautlcon.png</code> filed under ALOY-1318, ask for a better way in which Alloy handles <code>i18n</code> and <code>platform</code> folders.

For <code>X</code> read both <code>i18n</code> and <code>platform</code>:

* Like <code>/Resources</code>, the <code>/X</code> folders should be generated by Alloy.
* For Alloy apps, i18n and platform resources should be in the <code>/app/X</code> folders.
* On compile, Alloy should replace the <code>/X</code> folders with <code>/app/X</code>, then override with <code>app/theme/my-theme/X</code> (ALOY-858) and default with <code>app/widgets/my-widget/X</code> (ALOY-967 + ALOY-1059).
* Alloy will no longer need TIMOB-17446 since Titanium can use the default paths.

We should require an <code>app/X</code> folder to be present before we generate (and thus overwrite/replace}} <code>/X</code>. This will make sure that an existing Alloy app that only has <code>/X</code> and <code>/app/themes/my-theme/X</code> or <code>/app/widgets/my-widget/X</code> will not end up loosing the resources it had in <code>/X</code>. Of course the change will still be breaking because the resources in themes and widgets will no longer make it to the app. But the migration path is simple because the developer simply has to move the <code>/X</code> folders to <code>/app/X</code>. We could even do that for the developer, which would make it not breaking at all, although we still need to notify the developer of the change.

<h3>Comments</h3>

<ol>
<li>Malcolm Hollingsworth 2016-03-09

   [~fokkezb] 
   
   [~cbarber] and I had a long offline conversation about this back in Dec 2015. This was all discussed.  You reach out to him for details or I can let you have a transcript.
   
   tiapp.xml should ALSO be pushed into
   
   * *project/app/tiapp.xml*
   
   and then if required into
   
   * *project/app/themes/red/tiapp.xml*
   
   This fixes the last real hurdle of theming as long as all the above is also sorted.  I do not care if the themed versions are overwritten or merged - the ability to theme is the key.</li>
<li>Fokke Zandbergen 2016-03-10

   We should discuss that separately as this is currently urgent because of TIMOB-20537.
   
   We already have ALOY-1118 to discuss theming <code>tiapp.xml</code>, including the chicken-egg problem (since the CLI will have loaded <code>tiapp.xml</code> by the time Alloy compiles.</li>
<li>Chris Barber 2016-03-15

   PR: <a href="https://github.com/appcelerator/alloy/pull/766" rel="nofollow" target="_blank">https://github.com/appcelerator/alloy/pull/766</a>
   
   [~fokkezb] Care to give this a go? You can put <code>platform</code> and <code>i18n</code> directories in your <code>app</code> folder. When you build, the <code>platform/&lt;platform-name&gt;</code> and <code>i18n</code> folders in the root of the project get nuked and the files copied from the <code>app/platform</code> and <code>app/i18n</code> directories. There's no way logic to preserve the <code>platform</code> and <code>i18n</code> directories. Users will need to move those folders into the <code>app</code> directory. You can override the Alloy app <code>platform</code> and <code>i18n</code> files by using a theme. Lastly, a custom widget may have an <code>i18n</code> directory structure which gets merged with the <code>app/i18n</code> and <code>app/themes/&lt;theme&gt;/i18n</code> stings.
   
   This PR does not do any sort of differential build or smart file copying. It's not great, but it's also not terrible. At least it's only nuke the <code>platform/&lt;platform-name&gt;</code> instead of nuking the entire <code>platform</code> directory.
   
   There are no changes at the Titanium SDK level. This is purely solved in Alloy.</li>
<li>Fokke Zandbergen 2016-03-15

   Thanks [~cbarber]. I've tested all combinations I could think off and left a few comments on the PR.
   
   Two ideas for simple improvements not related to your changes.
   
   But more importantly two ideas to make sure this breaking change (which it still is after all) at least not deletes people's project <code>i18n</code> and <code>platform</code> folders without notice. We really can't just be deleting those. There's still people without versioning and backups there :D
   
   I also think we should bump Alloy to 1.8 to signal the impact of this change. Of course any breaking change should bump major and I'm fine with that as well, but since we've been adding features to patch versions since 1.7 I thought 1.8 would be more appropriate. In anyway, the error in the ideas I suggested needs to have the version we release this with.
   
   [~cng] we need to make sure CLI 5.2.1 has this Alloy version, of course.
   
   I'll do a blog post on Alloy theming to give this good exposure as well.</li>
<li>Malcolm Hollingsworth 2016-03-15

   [~cbarber] [~fokkezb] you can easily handle the concerns of deleting the root i18n and platform when putting this back in which will allow all existing projects to remain without change but be ready to update when the dev wants them to. 
   
   * Check to see if there is a theme folder, if there is check to see if the current theme has an i18n or a platform folder individually. If i18n matches then delete the matching root folder and copy the theme folder. Then repeat with the platform folder. If one or both does not exist then NO root folders are touched. If only one folder exists inside theme then ONLY that matching one is deleted - not the other. This allows the dev to only change one of the choose to and makes sure if the do not use the facility then no folders are deleted. 
   * If a matching folder inside theme was not found then check if i18n or platform folders are inside the app folder. If at least one is that was not already processed via the theme point above then repeat the same logic as the first point. 
   * In essence you ONLY delete a root folder if a matching folder exists in theme and if not in theme in app. I18n and platform folder checking are treated independently of each other. You do not delete root platform just because i18n folder was found you MUST also have found platform. 
   * New projects should have i18n and platform folders automatically created inside the app folder and documentation updated to match. 
   * Apps that have i18n or platform folders in the root but not in either theme or app folders should see a warning during processing to show those folders should be moved and be given a URL to the docs to see why
   
   This way all existing projects can continue as they do right now as root folders will not be deleted as there are no theme or app folder versions. When devs start to take advantage of the ability to relocate the platform and i18n folders. 
   
   A few if statements resolves all the problems and the warning console entry forwarns the need to update the app structure. </li>
<li>Chris Barber 2016-03-15

   Thanks for the feedback. I updated the PR with a bunch of fixes.
   
   First and foremost, I have now made it so that Alloy will create a file called <code>alloy_generated</code> in the <code>/i18n</code> and <code>/platform</code> directories. If this file exists, then I can nuke it without worry. If the <code>alloy_generated</code> file is missing, then the build fails with a message saying you must move those folders into your <code>app</code> directory. It's simple and robust.
   
   I also:
   * Fixed the i18n XML parsing to be more robust
   * Added <code>/i18n</code> and <code>/platform</code> to the <code>.gitignore</code> for new projects
   * Print a warning if there's a <code>.gitignore</code> and it's missing <code>/i18n</code>, <code>/platform</code>, or <code>/Resources</code>
   * Fixed a small bug with Alloy's hook when parsing the output from the subprocessed Alloy compile command
   * Bumped the version number to 1.8.0</li>
<li>Fokke Zandbergen 2016-03-16

   [~cbarber] looking good. One thing though, related to [~core13]'s remarks.
   
   If you <code>ti create</code> a Titanium project it includes <code>/platform</code>. Then if you run <code>alloy new</code> it will currently leave that folder there. After this PR the first time you <code>alloy compile</code> it will fail saying you need to move <code>/platform</code>.
   
   So, I think to finish this off we should modify [new](<a href="https://github.com/appcelerator/alloy/blob/master/Alloy/commands/new/index.js)" rel="nofollow" target="_blank">https://github.com/appcelerator/alloy/blob/master/Alloy/commands/new/index.js)</a> to:
   
   * Move <code>/platform</code> and <code>/i18n</code> under <code>/app</code>
   * [Ensure](<a href="https://github.com/appcelerator/alloy/blob/master/Alloy/commands/new/index.js#L23)" rel="nofollow" target="_blank">https://github.com/appcelerator/alloy/blob/master/Alloy/commands/new/index.js#L23)</a> <code>/app/platform</code>, <code>/app/i18n</code> (and I'd say also <code>/app/lib</code>) like it does with <code>/app/models</code> as a hint even if you don't have these folders.</li>
<li>Chris Barber 2016-03-16

   [~fokkezb] Done! Please review one last time.</li>
<li>Chris Barber 2016-03-21

   Here's the docs:
   
   {quote}
   Alloy has improved i18n and platform-specific resources support. You can now add "i18n" and "platform" directories in your "/app" directory and in your active theme's directory. Additionally, widgets may also have an "i18n" directory.
   
   When you build your app, Alloy will delete the "/i18n" and "/platform/<platform>" directories in the project's root directory. Next it will copy and merge the "i18n" and "platform/<platform>" directories from the Alloy app's directory into the project's root directory. For platform-specific files, it starts by copying all files from "/app/platform/<platform>", then overrides with files from "/app/theme/<theme name>/platform/<platform>". i18n files are copied from the "/app/i18n" and "/app/themes/<theme name>/i18n" directories followed by the each widget's "/app/widgets/<widget name>/i18n" directory.
   
   It's important to reiterate that the "/i18n", "/platform/<platform>", and "/Resources" directories are regenerated each time you build. Any manual change to files in these directories will be lost during the next build.
   
   When creating a new Alloy project, it will automatically move existing "/i18n" and "/platform" directories into the "/app" directory.
   
   Existing Alloy apps that already have "/i18n" or "/platform" directories in the project's root directory will fail to build until these directories into the "/app" directory.
   {quote}</li>
<li>Fokke Zandbergen 2016-03-23

    One note in regards to:
    
    {quote}followed by the each widget's "/app/widgets/<widget name>/i18n" directory.{quote}
    
    It is important to note that although widget i18n comes last, it won't override existing strings. This allows you to override widget strings in your theme.</li>
<li>Malcolm Hollingsworth 2016-03-23

    [~fokkezb] do you mean that i18n files are simply copied and if one already exists then it is overwritten?
    
    Or would widget i18n entries be merged into theme i18n entries if they exist and then merged into app i18n entries?
    
    I think a few example files in all possible locations with suitable strings should be given complete with the expected fully merged i18n that would then be used by the app itself. 
    
    Provided suitable string examples are given then this will make the trickle down rules very clear. </li>
<li>Fokke Zandbergen 2016-03-23

    [~core13] what I mean is that the behaviour is unchanged:
    
    * i18n XML files are merged
    * Although i18n XML files from widgets come last, they don't override existing strings, allowing you to override strings from (third-party) widgets in your theme or main i18n files.
    
    I have a blog post ready</li>
<li>Malcolm Hollingsworth 2016-03-24

    [~fokkezb] When updating features do you have a dependency checklist that you through to make sure that new rules work with dependant features as well?
    
    {noformat}
      alloy extract-i18n en â€”apply
    {noformat}
    
    This does not honour the correct locations of the app is an Alloy project. It always exports to the \{project/i18n/\} folder rather than the \{project/app/i18n/\} folder. 
    
    If you use a dependency checklist (sometimes called a knock-ons list) a lot of these issues that then need immediate triage would simply never occur. </li>
<li>Fokke Zandbergen 2016-03-24

    [~core13] No, apparently there was no unit test for <code>alloy extract-i18n</code>, which of course we should have.
    
    Luckily [~sfeather] found this bug already and we've got it fixed: ALOY-1375</li>
<li>Eric Wieber 2016-03-24

    Verified fixed, using:
    
    MacOS 10.11.4 (15E65)
    Studio 4.5.0.201602170821
    Ti SDK 5.2.1.v20160318225121
    Appc NPM 4.2.4-2
    Appc CLI 5.2.1-21
    Alloy 1.8.2
    Xcode 7.3 (7D175)
    
    The projects i18n and platform directories function as stated by Chris Barber, in the comments. They are copied from the /app directory, merged with theme and widget directories when appropriate, and sent back into the root folders with the addition of an alloy_generated file that indicates they have undergone this process. Builds fail with a message if the alloy_generated file is not present. Tested with multiple apps using different combinations of i18n and platform folder locations.</li>
</ol>


<p><a href="/ALOY/ALOY-1365.json">JSON Source</a></p>