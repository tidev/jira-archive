---
title: "[TIMOB-27406] Android: Cannot select content from downloads"
---
<table>
<tr><th>GitHub Issue</th><td>n/a</td></tr>
<tr><th>Type</th><td>Bug</td></tr>
<tr><th>Priority</th><td>Critical</td></tr>
<tr><th>Status</th><td>Closed</td></tr>
<tr><th>Resolution</th><td>Fixed</td></tr>
<tr><th>Resolution Date</th><td>2020-01-10T16:57:50.000+0000</td></tr>
<tr><th>Affected Version/s</th><td>Release 8.0.0, Release 8.1.0, Release 8.2.0</td></tr>
<tr><th>Fix Version/s</th><td>Release 9.0.0</td></tr>
<tr><th>Components</th><td>Android</td></tr>
<tr><th>Labels</th><td>android, engSchedule</td></tr>
<tr><th>Reporter</th><td>Francisco Antonio Duran Ramirez</td></tr>
<tr><th>Assignee</th><td>Gary Mathews</td></tr>
<tr><th>Created</th><td>2019-08-21T18:33:04.000+0000</td></tr>
<tr><th>Updated</th><td>2020-01-10T16:57:50.000+0000</td></tr>
</table>

<h3>Description</h3>

I downloaded the following image to the device, so after that in the app I am selecting the image from the gallery of download, and it is causing a black/ gray window after selecting the image.

<a href="http://www.effigis.com/wp-content/uploads/2015/02/Airbus_Pleiades_50cm_8bit_RGB_Yogyakarta.jpg" rel="nofollow" target="_blank">http://www.effigis.com/wp-content/uploads/2015/02/Airbus_Pleiades_50cm_8bit_RGB_Yogyakarta.jpg</a>

The purpose of use this huge image it is that I am using the ti.imagefactory module to compress the image, but at the moment I am selecting the image downloaded the app is behaving in this way showing a black or gray window. 

Note this issue is not happening in iOS.

XML:

<code><pre>
&lt;Alloy&gt;
	&lt;Window class="container"&gt;
		&lt;Label id="label" onClick="doClick"&gt;Hello, World&lt;/Label&gt;
		&lt;ImageView id="mImageContainer" bottom="30"/&gt;
	&lt;/Window&gt;
&lt;/Alloy&gt;
</pre></code>


JS:
<code><pre>
function doClick(e) {
	alert($.label.text);
	
	Titanium.Media.openPhotoGallery({
	        success:function(event)
	        {	          
	            if (event.mediaType == Ti.Media.MEDIA_TYPE_PHOTO) {
	            		Ti.API.info("success");
	            		$.mImageContainer.image = event.media;
	            		
	            }
	        },
	        cancel: function(e){
	        		Ti.API.info(e);
	        },
	        error:function(e) {
	        		Ti.API.info(e);
	        },
	        mediaTypes:[Ti.Media.MEDIA_TYPE_PHOTO]
    });
	
}

$.index.open();

</pre></code>


<code><pre>
[ERROR] TiExceptionHandler: (main) [15193,15193] Failure delivering result ResultInfo{who=null, request=1, result=-1, data=Intent { dat=co
ntent://com.android.providers.downloads.documents/document/raw:/storage/emulated/0/Download/x.jpg flg=0x1 }} to activity {com.tony.tony/or
g.appcelerator.titanium.TiActivity}: java.lang.NumberFormatException: For input string: "raw:/storage/emulated/0/Download/x.jpg"
[ERROR] TiExceptionHandler:
[ERROR] TiExceptionHandler:     java.lang.Long.parseLong(Long.java:594)
[ERROR] TiExceptionHandler:     java.lang.Long.valueOf(Long.java:808)
[ERROR] TiExceptionHandler:     org.appcelerator.titanium.io.TitaniumBlob.init(TitaniumBlob.java:89)
[ERROR] TiExceptionHandler:     org.appcelerator.titanium.io.TitaniumBlob.&lt;init&gt;(TitaniumBlob.java:41)
[ERROR] TiExceptionHandler:     org.appcelerator.titanium.io.TiFileFactory.createTitaniumFile(TiFileFactory.java:112)
[ERROR] TiExceptionHandler:     ti.modules.titanium.media.MediaModule.createImageData(MediaModule.java:1276)
[ERROR] TiExceptionHandler:     ti.modules.titanium.media.MediaModule.createDictForImage(MediaModule.java:1267)
[ERROR] TiExceptionHandler:     ti.modules.titanium.media.MediaModule$1.onResult(MediaModule.java:1199)
[ERROR] TiExceptionHandler:     org.appcelerator.titanium.util.TiActivitySupportHelper$1.onResult(TiActivitySupportHelper.java:60)
[ERROR] TiExceptionHandler:     org.appcelerator.titanium.util.TiActivitySupportHelper.onActivityResult(TiActivitySupportHelper.java:117)
[ERROR] TiExceptionHandler:     org.appcelerator.titanium.TiBaseActivity.onActivityResult(TiBaseActivity.java:905)
[ERROR] TiExceptionHandler:     android.app.Activity.dispatchActivityResult(Activity.java:7797)
[ERROR] TiExceptionHandler:     android.app.ActivityThread.deliverResults(ActivityThread.java:5071)
[ERROR] TiExceptionHandler:     android.app.ActivityThread.handleSendResult(ActivityThread.java:5120)
[ERROR] TiExceptionHandler:     android.app.servertransaction.ActivityResultItem.execute(ActivityResultItem.java:49)
[ERROR] TiExceptionHandler:     android.app.servertransaction.TransactionExecutor.executeCallbacks(TransactionExecutor.java:108)
[ERROR] TiExceptionHandler:     android.app.servertransaction.TransactionExecutor.execute(TransactionExecutor.java:68)
[ERROR] TiExceptionHandler:     android.app.ActivityThread$H.handleMessage(ActivityThread.java:2199)
[ERROR] TiExceptionHandler:     android.os.Handler.dispatchMessage(Handler.java:112)
[ERROR] TiExceptionHandler:     android.os.Looper.loop(Looper.java:216)
[ERROR] TiExceptionHandler:     android.app.ActivityThread.main(ActivityThread.java:7625)
[ERROR] TiExceptionHandler:     java.lang.reflect.Method.invoke(Native Method)
[ERROR] TiExceptionHandler:     com.android.internal.os.RuntimeInit$MethodAndArgsCaller.run(RuntimeInit.java:524)
[ERROR] TiExceptionHandler:     com.android.internal.os.ZygoteInit.main(ZygoteInit.java:987)
</pre></code>

Please let me know whether you have any doubt or question.

Thanks, and best,
Francisco Antonio Duran Ramirez.


<h3>Attachments</h3>

<table>
<thead>
<tr><th>File</th><th>Date</th><th>Size</th></tr><thead>
<tbody>
<tr><td><a href="https://jira-attachments.titaniumsdk.com/TIMOB/TIMOB-27406_66886/1566788007519.JPEG">1566788007519.JPEG</td></td><td>2019-08-26T04:24:21.000+0000</td><td>43794</td></tr>
<tr><td><a href="https://jira-attachments.titaniumsdk.com/TIMOB/TIMOB-27406_66887/console.docx">console.docx</td></td><td>2019-08-26T04:25:54.000+0000</td><td>12043</td></tr>
<tr><td><a href="https://jira-attachments.titaniumsdk.com/TIMOB/TIMOB-27406_66866/Screenshot_20190822-135247.png">Screenshot_20190822-135247.png</td></td><td>2019-08-22T07:55:27.000+0000</td><td>2074056</td></tr>
</tbody>
<table>

<h3>Comments</h3>

<ol>
<li>Rakhi Mitro 2019-08-22

   Hello,
   Tested the sample code provide by you with SDK 8.1.0.GA on Android 7 device(Huawei y9 2018) and does not able to reproduce the issue. Can you please share the correct code?
   
   Test output:
    !Screenshot_20190822-135247.png|thumbnail! </li>
<li>Francisco Antonio Duran Ramirez 2019-08-22

   Hello @Rakhi Mitro.  Good afternoon / morning.
   
   Please download, and use the image I mentioned before with the following link:
   
   <a href="http://www.effigis.com/wp-content/uploads/2015/02/Airbus_Pleiades_50cm_8bit_RGB_Yogyakarta.jpg" rel="nofollow" target="_blank">http://www.effigis.com/wp-content/uploads/2015/02/Airbus_Pleiades_50cm_8bit_RGB_Yogyakarta.jpg</a>
   
   
   The size of this image (link provided) is 41MB approximately, and the image you are using is 2.1MB approximately, so it seems that the issue is when we are using an image with a huge size.
   
   
   Please let me know whether you have any doubt or question.
   
   Thanks, and best,
   Francisco Antonio Duran Ramirez.</li>
<li>Michael Gangolf 2019-08-25

   [~antonioduran] [~rmitro] I think it is related to this: <a href="https://stackoverflow.com/questions/51136671/oreo-documentscontract-getdocumentiduri-returns-path-instead-of-long" rel="nofollow" target="_blank">https://stackoverflow.com/questions/51136671/oreo-documentscontract-getdocumentiduri-returns-path-instead-of-long</a>
   
   The problem is located in this line: <a href="https://github.com/appcelerator/titanium_mobile/blob/1a2343d1500a47ea5adabe8a52fcc077dd4b5169/android/titanium/src/java/org/appcelerator/titanium/io/TitaniumBlob.java#L89" rel="nofollow" target="_blank">https://github.com/appcelerator/titanium_mobile/blob/1a2343d1500a47ea5adabe8a52fcc077dd4b5169/android/titanium/src/java/org/appcelerator/titanium/io/TitaniumBlob.java#L89</a> and it is complaining about the parameter not beeing a number. Since [~antonioduran] is testing on Android 9 he has the problem while  [~rmitro] is testing on Android 7 which should be fine (if the image was downloaded from the Cloud, so it wasn't physically on the device while clicking on it in the gallery)</li>
<li>Joshua Quick 2019-08-26

   </li>
<li>Rodrigo Farfán 2019-09-17

   Hello everyone. Last night this issue was reported on TiSlack by Diego Freniche (@dfreniche) and I explored the line of code where the exception is thrown. After googling a couple of sites, I realized that this is a known issue when accessing files located in downloads folder. Take a look at this SO entry:
   <a href="https://stackoverflow.com/questions/51136671/oreo-documentscontract-getdocumentiduri-returns-path-instead-of-long" rel="nofollow" target="_blank">https://stackoverflow.com/questions/51136671/oreo-documentscontract-getdocumentiduri-returns-path-instead-of-long</a>
   
   That's why I switched my forked Titanium_Mobile code to branch 8_1_X and tried a work around that fixes this behaviour. Basically I modified the org.appcelerator.titanium.io.TitaniumBlob.java class doing this:
   
   <code><pre>
   
   } else if (url.startsWith("content://com.android.providers.downloads.documents")) {
   			// This was a file downloaded from the Google cloud.
   			String id = DocumentsContract.getDocumentId(Uri.parse(url));
   			// phobeous - 2019.09.17 - AC-6341 &gt;&gt; Start of modification
   			if (id.startsWith("raw:")) {
   				id = id.replaceFirst("raw:", "");
   				this.name = id.substring(id.lastIndexOf(File.pathSeparatorChar) + 1);
   				this.path = id;
   			} else { // phobeous - 2019.09.17 - AC-6341 &lt;&lt; End of modification
   				Uri uri = ContentUris.withAppendedId(Uri.parse("content://downloads/public_downloads"), Long.valueOf(id));
   				try (Cursor cursor = contentResolver.query(uri, projection, null, null, null)) {
   					if ((cursor != null) && cursor.moveToNext()) {
   						this.name = getStringFrom(cursor, 0);
   						this.path = getStringFrom(cursor, 1);
   					}
   				} catch (Exception ex) {
   				}
   			}
   		}
   
   </pre></code>
   
   Diego confirms it works. Please, consider this solution.</li>
<li>Rodrigo Farfán 2019-09-17

   Please, consider update this issue title to "Issue opening files from downloads folder on Android 8+"</li>
<li>Michael Gangolf 2019-09-17

   [~rfarfan] I've linked to the exact same issue some posts above :) Could have saved you some time. But at least you've tested it and made a PR! Please remove the commets "<code> phobeous - 2019.09.17 - TIMOB-27406 &gt;&gt; Start of modification</code>" from the PR and run "<code>clang-format -style=file -i android/src/....filename</code>" to make the validator happy </li>
<li>Rodrigo Farfán 2019-09-17

   Yeah. I visited this issue 3 or 4 weeks ago, but today I couldn't remember. Anyway, it took me more time building the SDK than searching on the web and apply the fix. Sorry for my silly comments in the code (it's my first PR ever). Comments are away now.</li>
<li>Gary Mathews 2019-12-13

   master: <a href="https://github.com/appcelerator/titanium_mobile/pull/11395" rel="nofollow" target="_blank">https://github.com/appcelerator/titanium_mobile/pull/11395</a></li>
<li>Samir Mohammed 2020-01-08

    FR Passed, Waiting on Jenkins build.</li>
<li>Christopher Williams 2020-01-09

    merged to master for 9.0.0</li>
<li>Samir Mohammed 2020-01-10

    Closing ticket, fix verified in SDK version <code>9.0.0.v20200109153329</code>. 
    
    Test and other information can be found at: 
    <a href="https://github.com/appcelerator/titanium_mobile/pull/11395" rel="nofollow" target="_blank">https://github.com/appcelerator/titanium_mobile/pull/11395</a></li>
</ol>


<p><a href="/TIMOB/TIMOB-27406.json">JSON Source</a></p>